<!DOCTYPE html>
<html>

    <head>
        <title>Website Contract</title>
        <link rel="stylesheet" href="/Resources/CSS/contractpage.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.11.1/pdf-lib.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>

    <body>
        <div id="pdf-container">
            <iframe src="/Resources/PDF/Website Development Contract.pdf" style="width: 100%; height: 400px;"></iframe>
        </div>
        <div id="signature-container">
            <label for="signature">Sign here:</label>
            <canvas id="signature" style="border: 1px solid black; max-width: 100%;"></canvas>
            <button id="clear-signature">Clear Signature</button>
            <button id="save-signature">Save Signature</button>
        </div>
        <script>
            const signatureCanvas = document.getElementById('signature');
            const clearButton = document.getElementById('clear-signature');
            const saveButton = document.getElementById('save-signature');

            const canvasContext = signatureCanvas.getContext('2d');
            canvasContext.lineWidth = 2;
            let isDrawing = false;

            // Event listeners for signature canvas
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('touchstart', startDrawing);

            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('touchmove', draw);

            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('touchend', stopDrawing);

            clearButton.addEventListener('click', clearSignature);
            saveButton.addEventListener('click', saveSignature);

            function startDrawing() {
                isDrawing = true;
            }

            function stopDrawing() {
                isDrawing = false;
                canvasContext.beginPath();  // Reset the path
            }

            function draw(event) {
                if (!isDrawing) return;

                if (event.type === 'touchmove') {
                    var touch = event.touches[0];
                    canvasContext.lineTo(touch.clientX - signatureCanvas.getBoundingClientRect().left, touch.clientY - signatureCanvas.getBoundingClientRect().top);
                } else {
                    canvasContext.lineTo(event.clientX - signatureCanvas.getBoundingClientRect().left, event.clientY - signatureCanvas.getBoundingClientRect().top);
                }

                canvasContext.stroke();
                canvasContext.beginPath();
                if (event.type === 'touchmove') {
                    var touch = event.touches[0];
                    canvasContext.moveTo(touch.clientX - signatureCanvas.getBoundingClientRect().left, touch.clientY - signatureCanvas.getBoundingClientRect().top);
                } else {
                    canvasContext.moveTo(event.clientX - signatureCanvas.getBoundingClientRect().left, event.clientY - signatureCanvas.getBoundingClientRect().top);
                }
            }

            function clearSignature() {
                canvasContext.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            }

            // Function to save the signature
            async function saveSignature() {
                const signatureDataURL = signatureCanvas.toDataURL();

                // Fetch your PDF
                const existingPdfBytes = await fetch('/Resources/PDF/Website Development Contract.pdf').then(res => res.arrayBuffer());

                // Load a PDF with the PDF-lib library
                const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);

                // Embed the PNG image bytes (you can also embed JPEGs)
                const pngImage = await pdfDoc.embedPng(signatureDataURL);

                // Get the fifth page. Remember that pages are 0-indexed.
                const page = pdfDoc.getPages()[3];

                const pageWidth = page.getWidth();
                const signatureWidth = signatureCanvas.width;
                const signatureHeight = signatureCanvas.height;

                // Calculate x position for centering the image at the bottom
                const xPosition = (pageWidth - signatureWidth) / 2;
                const yPosition = 0; // Keeping it at the bottom

                // Draw the png image on the fifth page at the calculated position
                page.drawImage(pngImage, {
                    x: xPosition,
                    y: yPosition,
                    width: signatureWidth,
                    height: signatureHeight,
                });

                // Serialize the PDF to bytes (Uint8Array)
                const pdfBytes = await pdfDoc.save();

                // Trigger the download
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'Contract_with_Signature.pdf';
                link.click();
            }

        </script>
    </body>

</html>